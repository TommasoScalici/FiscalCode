@page "/"

@using FiscalCode.Components.Shared
@using FiscalCode.Configuration
@using FiscalCode.Data
@using FiscalCode.Resources.Languages
@using FiscalCode.Services
@using System.Diagnostics

@inject IDialogService DialogService
@inject IStringLocalizer<Localization> Localizer;
@inject FiscalCodeDataService Service


<AppBar OnAddButtonClicked="OpenAddFormDialogAsync" />

<div class="flex flex-wrap flex-grow">
    @foreach (var item in fiscalCodes)
    {
        <Card FiscalCodeDTO="item" OnEdit="@(() => OpenEditFormDialogAsync(item))" OnDelete="DeleteFiscalCode" />
    }
</div>


@code {
    private List<FiscalCodeDTO> fiscalCodes = new()
    {
        new FiscalCodeDTO
        {
            FirstName = "Tommaso",
            LastName = "Scalici",
            Sex = "M",
            BirthDate = new DateTime(1991, 07, 18),
            BirthPlace = new BirthplaceDTO { Name = "Palermo", State = "PA"},
            FiscalCode = "SCLTMS91L18G273O"
        },
        new FiscalCodeDTO
        {
            FirstName = "Carla",
            LastName = "Craparotta",
            Sex = "M",
            BirthDate = new DateTime(1991, 07, 18),
            BirthPlace = new BirthplaceDTO { Name = "Palermo", State = "PA"},
            FiscalCode = "SCLTMS91L18G273O"
        },
        new FiscalCodeDTO
        {
            FirstName = "Pinco",
            LastName = "Pallino",
            Sex = "M",
            BirthDate = new DateTime(1991, 07, 18),
            BirthPlace = new BirthplaceDTO { Name = "Palermo", State = "PA"},
            FiscalCode = "SCLTMS91L18G273O"
        }
    };

    private void DeleteFiscalCode(FiscalCodeDTO dto) => fiscalCodes.Remove(dto);

    private async Task OpenAddFormDialogAsync()
    {
        try
        {
            var dialog = await DialogService.ShowAsync<FormDialog>(Localizer["FillData"], Config.DialogOptions);
            var result = await dialog.Result;

            if (result.Data is FiscalCodeDTO dto)
            {
                dto.FiscalCode = await Service.CalculateFiscalCodeAsync(dto);
                fiscalCodes.Add(dto);
            }
        }

        catch (Exception ex)
        {
            Debug.WriteLine(ex);
        }        
    }

    private async Task OpenEditFormDialogAsync(FiscalCodeDTO dto)
    {
        var parameters = new DialogParameters<FormDialog>();
        parameters.Add(d => d.FormData, dto);
        var dialog = await DialogService.ShowAsync<FormDialog>(Localizer["FillData"], parameters, Config.DialogOptions);
        var result = await dialog.Result;
    }
}